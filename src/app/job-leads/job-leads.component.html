<div *ngIf="loading" class="d-flex justify-content-center">
  <div class="spinner-border text-dark" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<ng-container *ngIf="!loading">
  <!-- Search -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex flex-wrap align-items-end gap-2">
        <div class="flex-grow-1" style="min-width: 200px; position: relative;">
          <input type="text" class="form-control" [(ngModel)]="filters.search" (keyup.enter)="applyFilters()"
            placeholder="Search by job title or company name..." [style.padding-right]="filters.search ? '35px' : ''">
          <button *ngIf="filters.search" 
                  type="button" 
                  class="btn btn-sm p-0 border-0 bg-transparent" 
                  (click)="resetFilters()"
                  style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); z-index: 10; cursor: pointer;"
                  title="Clear search">
            <i class="fas fa-times text-muted"></i>
          </button>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary" (click)="applyFilters()">
            <i class="fas fa-search"></i> Search
          </button>
          <div class="d-flex align-items-center px-3">
            <span class="text-muted">Total Jobs: <strong>{{ total }}</strong></span>
          </div>
        </div>
        <div class="ms-auto">
          <button class="btn btn-danger" (click)="deleteAllJobs()" [disabled]="deletingAll || jobs.length === 0">
            <i class="fas fa-trash-alt"></i> {{ deletingAll ? 'Deleting...' : 'Delete All' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Jobs Table -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th (click)="sortBy('companyName')" class="cursor-pointer">
                Company
                <i class="fas ms-1" [ngClass]="getSortIcon('companyName')"></i>
              </th>
              <th (click)="sortBy('title')" class="cursor-pointer">
                Job Title
                <i class="fas ms-1" [ngClass]="getSortIcon('title')"></i>
              </th>
              <th (click)="sortBy('primaryRoleTitle')" class="cursor-pointer">
                Role
                <i class="fas ms-1" [ngClass]="getSortIcon('primaryRoleTitle')"></i>
              </th>
              <th nowrap="true" (click)="sortBy('companySize')" class="cursor-pointer">
                Company Size
                <i class="fas ms-1" [ngClass]="getSortIcon('companySize')"></i>
              </th>
              <th>Website</th>
              <th>LinkedIn</th>
              <th>Team</th>
              <th (click)="sortBy('leadScrapingStatus')" class="cursor-pointer">
                Lead Scraping Status
                <i class="fas ms-1" [ngClass]="getSortIcon('leadScrapingStatus')"></i>
              </th>
              <th (click)="sortBy('updatedAt')" class="cursor-pointer">
                Updated
                <i class="fas ms-1" [ngClass]="getSortIcon('updatedAt')"></i>
              </th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let job of jobs">
              <td>
                <div class="d-flex align-items-center gap-2">
                  <img *ngIf="job.companyProfileUrl" 
                       [src]="job.companyProfileUrl" 
                       [alt]="job.companyName" 
                       class="company-logo"
                       (error)="$any($event.target).style.display='none'">
                  <span>{{ job.companyName }}</span>
                </div>
              </td>
              <td>
                <div class="text-truncate job-title-cell" [title]="job.title">
                  {{ job.title }}
                </div>
              </td>
              <td>
                <span class="badge bg-info">{{ job.primaryRoleTitle }}</span>
              </td>
              <td>
                <span *ngIf="job.companySize" class="badge bg-light text-dark">{{ formatCompanySize(job.companySize)
                  }}</span>
                <span *ngIf="!job.companySize" class="text-muted">-</span>
              </td>
              <td>
                <a *ngIf="job.companyUrl" [href]="job.companyUrl" target="_blank" rel="noopener noreferrer" class="text-primary">
                  <i class="fas fa-external-link-alt"></i>
                </a>
                <span *ngIf="!job.companyUrl" class="text-muted">-</span>
              </td>
              <td>
                <a *ngIf="job.companyLinkedInUrl" [href]="job.companyLinkedInUrl" target="_blank" rel="noopener noreferrer" class="text-primary">
                  <i class="fab fa-linkedin"></i>
                </a>
                <span *ngIf="!job.companyLinkedInUrl" class="text-muted">-</span>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <ng-container *ngIf="job.companyFounders && job.companyFounders.length > 0">
                    <ng-container *ngFor="let founder of job.companyFounders">
                      <a *ngIf="founder.linkedinUrl"
                         [href]="founder.linkedinUrl" 
                         target="_blank" 
                         rel="noopener noreferrer"
                         class="badge bg-success text-decoration-none"
                         [title]="founder.name">
                        {{ trimName(founder.name) }}
                      </a>
                      <span *ngIf="!founder.linkedinUrl"
                            class="badge bg-success"
                            [title]="founder.name">
                        {{ trimName(founder.name) }}
                      </span>
                    </ng-container>
                  </ng-container>
                  <ng-container *ngIf="job.companyTeamMembers && job.companyTeamMembers.length > 0">
                    <ng-container *ngFor="let member of job.companyTeamMembers">
                      <a *ngIf="member.linkedinUrl"
                         [href]="member.linkedinUrl" 
                         target="_blank" 
                         rel="noopener noreferrer"
                         class="badge text-decoration-none"
                         [ngClass]="isFounder(member.name, job.companyFounders) ? 'bg-success' : 'bg-secondary'"
                         [title]="member.name">
                        {{ trimName(member.name) }}
                      </a>
                      <span *ngIf="!member.linkedinUrl"
                            class="badge"
                            [ngClass]="isFounder(member.name, job.companyFounders) ? 'bg-success' : 'bg-secondary'"
                            [title]="member.name">
                        {{ trimName(member.name) }}
                      </span>
                    </ng-container>
                  </ng-container>
                </div>
                <span *ngIf="(!job.companyFounders || job.companyFounders.length === 0) && (!job.companyTeamMembers || job.companyTeamMembers.length === 0)" class="text-muted">-</span>
              </td>
              <td>
                <span *ngIf="job.leadScrapingStatus" class="badge" [ngClass]="getLeadScrapingStatusBadgeClass(job.leadScrapingStatus)">
                  {{ job.leadScrapingStatus }}
                </span>
                <span *ngIf="!job.leadScrapingStatus" class="text-muted">-</span>
              </td>
              <td>{{ job.updatedAt | date:'dd-MM-yyyy hh:mm a' }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary me-2" (click)="viewJobDetails(job)" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteJob(job.id)" title="Delete">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </td>
            </tr>
             <tr *ngIf="jobs.length === 0 && !loading">
               <td colspan="10" class="text-center py-4">
                 <p class="text-muted">No jobs found</p>
               </td>
             </tr>
          </tbody>
        </table>
      </div>
      <div class="row mt-3" *ngIf="jobs.length > 0">
        <div class="col-12 text-center">
          <div *ngIf="loadingMore" class="py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2 text-muted">Loading more jobs...</span>
          </div>
          <div *ngIf="!hasMore && !loadingMore" class="py-3">
            <p class="text-muted mb-0">No more jobs to load</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Job Details Modal -->
<div class="modal fade" [class.show]="showJobDetails" [style.display]="showJobDetails ? 'block' : 'none'" tabindex="-1"
  *ngIf="showJobDetails && selectedJob">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Job Details</h5>
        <button type="button" class="btn-close" (click)="closeJobDetails()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-12 mb-3">
            <div class="d-flex align-items-center gap-3 mb-2">
              <img *ngIf="selectedJob.companyProfileUrl" 
                   [src]="selectedJob.companyProfileUrl" 
                   [alt]="selectedJob.companyName" 
                   class="company-logo-modal"
                   (error)="$any($event.target).style.display='none'">
              <div>
                <h4 class="mb-0">{{ selectedJob.title }}</h4>
                <p class="text-muted mb-0" *ngIf="selectedJob.companyName">
                  <strong>Company:</strong> {{ selectedJob.companyName }}
                </p>
              </div>
            </div>
          </div>

          <div class="col-12 mb-3" *ngIf="selectedJob.highConcept">
            <strong>Company Description:</strong>
            <div class="mt-2 p-3 bg-light rounded">{{ selectedJob.highConcept }}</div>
          </div>

          <div class="col-12 mb-3" *ngIf="selectedJob.companyBadges && selectedJob.companyBadges.length > 0">
            <strong>Company Badges:</strong>
            <div class="mt-2">
              <span *ngFor="let badge of selectedJob.companyBadges" class="badge bg-primary me-2">
                {{ badge }}
              </span>
            </div>
          </div>

          <div class="col-12">
            <hr>
          </div>

          <div class="col-12 col-md-6 mb-3">
            <strong>Job ID:</strong> {{ selectedJob.id }}
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Slug:</strong> {{ selectedJob.slug }}
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Role:</strong> <span class="badge bg-info">{{ selectedJob.primaryRoleTitle }}</span>
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Type:</strong> <span class="badge bg-secondary">{{ selectedJob.jobType }}</span>
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Remote:</strong>
            <span class="badge" [ngClass]="selectedJob.remote ? 'bg-success' : 'bg-warning'">
              {{ selectedJob.remote ? 'Remote' : 'On-site' }}
            </span>
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Lead Scraping Status:</strong>
            <span *ngIf="selectedJob.leadScrapingStatus" class="badge ms-2" [ngClass]="getLeadScrapingStatusBadgeClass(selectedJob.leadScrapingStatus)">
              {{ selectedJob.leadScrapingStatus }}
            </span>
            <span *ngIf="!selectedJob.leadScrapingStatus" class="text-muted ms-2">-</span>
          </div>
          <div class="col-12 col-md-6 mb-3" *ngIf="selectedJob.compensation">
            <strong>Compensation:</strong> {{ selectedJob.compensation }}
          </div>
          <div class="col-12 col-md-6 mb-3" *ngIf="selectedJob.equity">
            <strong>Equity:</strong> {{ selectedJob.equity }}
          </div>
          <div class="col-12 col-md-6 mb-3" *ngIf="selectedJob.companySize">
            <strong>Company Size:</strong> {{ formatCompanySize(selectedJob.companySize) }}
          </div>
          <div class="col-12 col-md-6 mb-3" *ngIf="selectedJob.companySlug">
            <strong>Company Slug:</strong> {{ selectedJob.companySlug }}
          </div>
          <div class="col-12 col-md-6 mb-3" *ngIf="selectedJob.startupId">
            <strong>Startup ID:</strong> {{ selectedJob.startupId }}
          </div>
          <div class="col-12 col-md-6 mb-3" *ngIf="selectedJob.companyTotalRaised">
            <strong>Total Raised:</strong> {{ formatCurrency(selectedJob.companyTotalRaised) }}
          </div>
          <div class="col-12 mb-3" *ngIf="selectedJob.companyLocations && selectedJob.companyLocations.length > 0">
            <strong>Locations:</strong>
            <div class="mt-1">
              <span *ngFor="let location of selectedJob.companyLocations" class="badge bg-secondary me-1">
                {{ location }}
              </span>
            </div>
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Created:</strong> {{ selectedJob.createdAt | date:'medium' }}
          </div>
          <div class="col-12 col-md-6 mb-3">
            <strong>Updated:</strong> {{ selectedJob.updatedAt | date:'medium' }}
          </div>

          <div class="col-12">
            <hr>
          </div>

          <div class="col-12 mb-3"
            *ngIf="selectedJob.companyUrl || selectedJob.companyBlogUrl || selectedJob.companyLinkedInUrl || selectedJob.companyTwitterUrl || selectedJob.companyFacebookUrl || selectedJob.companyInstagramUrl">
            <strong>Company URLs:</strong>
            <div class="mt-2">
              <div *ngIf="selectedJob.companyUrl" class="mb-2">
                <strong>Website:</strong> <a [href]="selectedJob.companyUrl" target="_blank"
                  rel="noopener noreferrer">{{ selectedJob.companyUrl }}</a>
              </div>
              <div *ngIf="selectedJob.companyBlogUrl" class="mb-2">
                <strong>Blog:</strong> <a [href]="selectedJob.companyBlogUrl" target="_blank"
                  rel="noopener noreferrer">{{ selectedJob.companyBlogUrl }}</a>
              </div>
              <div *ngIf="selectedJob.companyLinkedInUrl" class="mb-2">
                <strong>LinkedIn:</strong> <a [href]="selectedJob.companyLinkedInUrl" target="_blank"
                  rel="noopener noreferrer">{{ selectedJob.companyLinkedInUrl }}</a>
              </div>
              <div *ngIf="selectedJob.companyTwitterUrl" class="mb-2">
                <strong>Twitter:</strong> <a [href]="selectedJob.companyTwitterUrl" target="_blank"
                  rel="noopener noreferrer">{{ selectedJob.companyTwitterUrl }}</a>
              </div>
              <div *ngIf="selectedJob.companyFacebookUrl" class="mb-2">
                <strong>Facebook:</strong> <a [href]="selectedJob.companyFacebookUrl" target="_blank"
                  rel="noopener noreferrer">{{ selectedJob.companyFacebookUrl }}</a>
              </div>
              <div *ngIf="selectedJob.companyInstagramUrl" class="mb-2">
                <strong>Instagram:</strong> <a [href]="selectedJob.companyInstagramUrl" target="_blank"
                  rel="noopener noreferrer">{{ selectedJob.companyInstagramUrl }}</a>
              </div>
            </div>
          </div>

          <div class="col-12 mb-3" *ngIf="selectedJob.companyFounders && selectedJob.companyFounders.length > 0">
            <strong>Company Founders:</strong>
            <div class="mt-2">
              <div *ngFor="let founder of selectedJob.companyFounders" class="card mb-2">
                <div class="card-body p-3">
                  <div>
                    <h6 class="mb-1">{{ founder.name }}</h6>
                    <div *ngIf="founder.role" class="text-muted mb-1">{{ founder.role }}</div>
                    <div *ngIf="founder.bio" class="mb-2" [innerHTML]="founder.bio"></div>
                    <div class="d-flex gap-2">
                      <a *ngIf="founder.linkedinUrl" [href]="founder.linkedinUrl" target="_blank"
                        rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                        <i class="fab fa-linkedin"></i> LinkedIn
                      </a>
                      <span *ngIf="founder.slug" class="text-muted small">Slug: {{ founder.slug }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 mb-3" *ngIf="selectedJob.companyTeamMembers && selectedJob.companyTeamMembers.length > 0">
            <strong>Company Team Members:</strong>
            <div class="mt-2">
              <div *ngFor="let member of selectedJob.companyTeamMembers" class="card mb-2">
                <div class="card-body p-3">
                  <div class="d-flex align-items-start">
                    <img *ngIf="member.avatarUrl" [src]="member.avatarUrl" [alt]="member.name" class="rounded me-3"
                      style="width: 60px; height: 60px; object-fit: cover;">
                    <div class="flex-grow-1">
                      <h6 class="mb-1">{{ member.name }}</h6>
                      <div *ngIf="member.role" class="text-muted mb-1">{{ member.role }}</div>
                      <div *ngIf="member.bio" class="mb-2" [innerHTML]="member.bio"></div>
                      <div class="d-flex gap-2">
                        <a *ngIf="member.linkedinUrl" [href]="member.linkedinUrl" target="_blank"
                          rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                          <i class="fab fa-linkedin"></i> LinkedIn
                        </a>
                        <span *ngIf="member.slug" class="text-muted small">Slug: {{ member.slug }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 mb-3" *ngIf="selectedJob.description">
            <strong>Job Description:</strong>
            <div class="mt-2 p-3 bg-light rounded job-description"
              [innerHTML]="formatDescription(selectedJob.description)"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeJobDetails()">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showJobDetails" *ngIf="showJobDetails" (click)="closeJobDetails()"></div>